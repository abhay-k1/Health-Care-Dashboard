<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Youth Health Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 50%, #e0f2fe 100%);
            background-size: 300% 300%;
            animation: gradientFade 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
        }

        @keyframes gradientFade {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            font-size: 28px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 4px;
        }

        .header-content h1 .highlight {
            background: linear-gradient(to right, #0ea5e9, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-content p {
            color: #6b7280;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(to right, #0ea5e9, #3b82f6);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.08);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #111827;
            line-height: 1;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.blue {
            background: #dbeafe;
            color: #2563eb;
        }

        .stat-icon.green {
            background: #d1fae5;
            color: #059669;
        }

        .stat-icon.orange {
            background: #fed7aa;
            color: #ea580c;
        }

        .stat-icon.purple {
            background: #e9d5ff;
            color: #9333ea;
        }

        .stat-change {
            font-size: 12px;
            color: #10b981;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dashboard-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .insight-card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #bfdbfe;
        }

        .insight-label {
            font-size: 13px;
            color: #1e40af;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .insight-value {
            font-size: 28px;
            font-weight: bold;
            color: #1e3a8a;
        }

        .issues-list {
            margin-top: 24px;
        }

        .issue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: transform 0.2s;
        }

        .issue-item:hover {
            transform: translateX(4px);
        }

        .issue-name {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #374151;
            font-weight: 500;
        }

        .issue-count {
            background: #fee2e2;
            color: #dc2626;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 24px;
        }

        .empty-state {
            text-align: center;
            padding: 48px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.5;
        }

        .refresh-btn {
            position: absolute;
            top: 32px;
            right: 32px;
            background: #f3f4f6;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: #e5e7eb;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
            }

            .btn {
                width: 100%;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Youth Health <span class="highlight">Analytics</span></h1>
                <p>Real-time Dashboard - User Portal</p>
            </div>
            <div class="header-actions">
                <button class="refresh-btn" onclick="loadDashboardData()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                    Refresh
                </button>
                <a href="questionnaire.html" class="btn btn-primary" id="questionnaireBtn">Take Assessment</a>
                <a href="results.html" class="btn btn-secondary" id="resultsBtn" style="display: none;">View Results</a>
                <button class="btn btn-secondary" id="aiHelperBtn" onclick="playAIInsights()"
                    style="background: linear-gradient(to right, #8b5cf6, #3b82f6);">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"
                        style="display:inline-block; vertical-align:-3px; margin-right:4px;">
                        <path d="M10 2a4 4 0 014 4v2a4 4 0 01-8 0V6a4 4 0 014-4z"></path>
                        <path fill-rule="evenodd"
                            d="M6 8a1 1 0 00-2 0v2a6.002 6.002 0 005 5.917V19h-1a1 1 0 100 2h4a1 1 0 100-2h-1v-3.083A6.002 6.002 0 0016 10V8a1 1 0 10-2 0v2a4 4 0 01-8 0V8z"
                            clip-rule="evenodd"></path>
                    </svg>
                    AI Helper
                </button>
                <button class="btn btn-danger" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total Participants</div>
                        <div class="stat-value" id="totalParticipants">0</div>
                        <div class="stat-change">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            Real-time data
                        </div>
                    </div>
                    <div class="stat-icon blue">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Active Programs</div>
                        <div class="stat-value" id="activePrograms">0</div>
                        <div class="stat-change">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            Currently active
                        </div>
                    </div>
                    <div class="stat-icon green">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Health Reports Generated</div>
                        <div class="stat-value" id="healthReports">0</div>
                        <div class="stat-change">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            Completed assessments
                        </div>
                    </div>
                    <div class="stat-icon orange">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-change">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            Assessment completion
                        </div>
                    </div>
                    <div class="stat-icon purple">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Insights & Analytics Section -->
        <div class="dashboard-section">
            <h2 class="section-title">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
                User Insights & Analytics
            </h2>

            <div class="insights-grid">
                <div class="insight-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                    <div class="insight-label">Total Users Logged In</div>
                    <div class="insight-value" id="totalUsers">0</div>
                </div>
                <div class="insight-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);">
                    <div class="insight-label">Completed Assessments</div>
                    <div class="insight-value" id="completedAssessments">0</div>
                </div>
                <div class="insight-card" style="background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);">
                    <div class="insight-label">Users Needing Support</div>
                    <div class="insight-value" id="usersNeedingSupport">0</div>
                </div>
                <div class="insight-card" style="background: linear-gradient(135deg, #fdf4ff 0%, #e9d5ff 100%);">
                    <div class="insight-label">Average Health Score</div>
                    <div class="insight-value" id="avgHealthScore">0</div>
                </div>
            </div>

            <div class="issues-list">
                <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 16px;">Common Health Issues
                    Identified</h3>
                <div id="issuesList">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <p>No health issues data available yet. Complete assessments to see insights.</p>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="issuesChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const SARVAM_API_KEY = "sk_ln1ow9q0_VyTVyU7GDcGnPVczSPWRJ1Yr";
        let issuesChart = null;

        // Check authentication
        if (localStorage.getItem('userAuthenticated') !== 'true') {
            window.location.href = 'user-login.html';
        }

        // Check if user has completed questionnaire
        const userEmail = localStorage.getItem('userEmail');
        const questionnaireCompleted = localStorage.getItem('questionnaireCompleted') === 'true';

        if (questionnaireCompleted) {
            document.getElementById('questionnaireBtn').style.display = 'none';
            document.getElementById('resultsBtn').style.display = 'inline-block';
        }

        // Load dashboard data on page load
        window.addEventListener('load', function () {
            loadDashboardData();
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });

        function loadDashboardData() {
            seedMockData(); // Ensure mock data exists
            // Load all real user data
            const allUsersData = JSON.parse(localStorage.getItem('allUsersData') || '[]');
            const allUserLogins = JSON.parse(localStorage.getItem('allUserLogins') || '[]');

            // Calculate real statistics
            const totalParticipants = allUserLogins.length;
            const completedAssessments = allUsersData.filter(u =>
                u.data && u.data.completion && u.data.completion.completed
            ).length;

            // Calculate active programs (users who logged in within last 30 days and completed assessment)
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const activePrograms = allUserLogins.filter(login => {
                const lastLogin = login.lastLogin || login.firstLogin;
                return lastLogin >= thirtyDaysAgo;
            }).length;

            // Calculate health reports (completed assessments with data)
            const healthReports = allUsersData.filter(u =>
                u.data && u.data.questionnaire && u.data.completion && u.data.completion.completed
            ).length;

            // Calculate completion rate
            const completionRate = totalParticipants > 0
                ? Math.round((completedAssessments / totalParticipants) * 100)
                : 0;

            // Calculate users needing support (those with identified issues)
            let usersNeedingSupport = 0;
            const allIssues = [];
            let totalHealthScore = 0;
            let healthScoreCount = 0;

            allUsersData.forEach(user => {
                if (user.data && user.data.questionnaire) {
                    const issues = analyzeUserData(user.data.questionnaire.answers || {});
                    if (issues.length > 0) {
                        usersNeedingSupport++;
                        allIssues.push(...issues);
                    }

                    // Calculate health score (inverse of issues - more issues = lower score)
                    const healthScore = Math.max(0, 100 - (issues.length * 10));
                    totalHealthScore += healthScore;
                    healthScoreCount++;
                }
            });

            const avgHealthScore = healthScoreCount > 0
                ? Math.round(totalHealthScore / healthScoreCount)
                : 0;

            // Update statistics
            document.getElementById('totalParticipants').textContent = totalParticipants.toLocaleString();
            document.getElementById('activePrograms').textContent = activePrograms;
            document.getElementById('healthReports').textContent = healthReports;
            document.getElementById('completionRate').textContent = completionRate + '%';

            // Update insights
            document.getElementById('totalUsers').textContent = totalParticipants;
            document.getElementById('completedAssessments').textContent = completedAssessments;
            document.getElementById('usersNeedingSupport').textContent = usersNeedingSupport;
            document.getElementById('avgHealthScore').textContent = avgHealthScore;

            // Count common issues
            const issueCounts = {};
            allIssues.forEach(issue => {
                issueCounts[issue] = (issueCounts[issue] || 0) + 1;
            });

            // Display common issues
            const issuesList = document.getElementById('issuesList');
            const sortedIssues = Object.entries(issueCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (sortedIssues.length > 0) {
                issuesList.innerHTML = sortedIssues.map(([issue, count]) => `
                    <div class="issue-item">
                        <div class="issue-name">
                            <span>‚ö†Ô∏è</span>
                            <span>${issue}</span>
                        </div>
                        <div class="issue-count">${count} ${count === 1 ? 'user' : 'users'}</div>
                    </div>
                `).join('');
            } else {
                issuesList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No health issues data available yet. Complete assessments to see insights.</p>
                    </div>
                `;
            }

            // Update chart
            updateIssuesChart(sortedIssues);
        }

        function analyzeUserData(answers) {
            const issues = [];

            // Question 1: Energy levels
            if (answers[1] === 'low' || answers[1] === 'very_low') issues.push('Low Energy Levels');

            // Question 2: Sleep hours
            if (answers[2] === '5-6' || answers[2] === 'less_5') issues.push('Sleep Deprivation');

            // Question 3: Stress/Anxiety
            if (answers[3] === 'often' || answers[3] === 'daily') issues.push('High Stress/Anxiety');

            // Question 4: Physical activity
            if (answers[4] === 'moderate' || answers[4] === 'inactive') issues.push('Physical Inactivity');

            // Question 5: Physical pain
            if (answers[5] === 'moderate' || answers[5] === 'severe') issues.push('Physical Pain');

            // Question 6: Nutrition
            if (answers[6] === 'fair' || answers[6] === 'poor') issues.push('Poor Nutrition');

            // Question 7: Coping mechanisms
            if (answers[7] === 'often' || answers[7] === 'sometimes') issues.push('Coping Difficulties');

            // Question 8: Concentration
            if (answers[8] === 'often') issues.push('Concentration Issues');

            // Question 9: Social connections
            if (answers[9] === 'fair' || answers[9] === 'poor') issues.push('Social Isolation');

            return issues;
        }

        function seedMockData() {
            const existingData = localStorage.getItem('allUsersData');
            if (existingData && JSON.parse(existingData).length > 0) return;

            console.log("Seeding mock data for analytics...");
            const numberOfUsers = 50;

            const ages = ['13-17', '18-22', '23-27', '28-32', '33+'];
            const genders = ['male', 'female', 'non-binary', 'prefer-not-to-say'];
            const professions = ['student', 'working', 'both', 'other'];
            const answerOptions = {
                1: ['high', 'moderate', 'low', 'very_low'],
                2: ['9+', '7-8', '5-6', 'less_5'],
                3: ['rarely', 'sometimes', 'often', 'daily'],
                4: ['very_active', 'active', 'moderate', 'inactive'],
                5: ['none', 'mild', 'moderate', 'severe'],
                6: ['excellent', 'good', 'fair', 'poor'],
                7: ['never', 'rarely', 'sometimes', 'often'],
                8: ['never', 'rarely', 'sometimes', 'often'],
                9: ['excellent', 'good', 'fair', 'poor'],
                10: ['none', 'minor', 'moderate', 'major']
            };

            const allUsersData = [];
            const allUserLogins = [];
            const demographicsTracking = [];
            const funnelAnalytics = {
                visited: numberOfUsers + 30,
                attempted: numberOfUsers + 15,
                completed: numberOfUsers
            };
            const questionAnalytics = {};

            for (let i = 1; i <= numberOfUsers; i++) {
                const email = `mockuser${i}@example.com`;
                const timestamp = Date.now() - Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000);

                const age = ages[Math.floor(Math.random() * ages.length)];
                const gender = genders[Math.floor(Math.random() * genders.length)];
                const profession = professions[Math.floor(Math.random() * professions.length)];

                const answers = {};
                const questionTimes = {};
                for (let q = 1; q <= 10; q++) {
                    const opts = answerOptions[q];
                    let selectedIndex;
                    if (q === 2 || q === 3) {
                        selectedIndex = Math.min(opts.length - 1, Math.floor(Math.random() * 2) + 2);
                    } else {
                        selectedIndex = Math.floor(Math.random() * opts.length);
                    }
                    answers[q] = opts[selectedIndex];

                    const timeSpent = Math.floor(Math.random() * 8000) + 2000;
                    questionTimes[q] = timeSpent;

                    if (!questionAnalytics[q]) questionAnalytics[q] = [];
                    questionAnalytics[q].push(timeSpent);
                }

                allUsersData.push({
                    email: email,
                    timestamp: timestamp,
                    lastUpdated: timestamp,
                    data: {
                        demographics: { age, profession, gender },
                        questionnaire: {
                            demographics: { age, profession, gender },
                            answers: answers,
                            questionTimes: questionTimes,
                            completedAt: timestamp + 60000
                        },
                        completion: { completed: true, timestamp: timestamp + 60000 }
                    }
                });

                allUserLogins.push({
                    email: email,
                    firstLogin: timestamp - 86400000,
                    lastLogin: timestamp,
                    loginCount: Math.floor(Math.random() * 5) + 1
                });

                demographicsTracking.push({
                    email: email,
                    age: age,
                    gender: gender,
                    profession: profession,
                    timestamp: timestamp
                });
            }

            localStorage.setItem('allUsersData', JSON.stringify(allUsersData));
            localStorage.setItem('allUserLogins', JSON.stringify(allUserLogins));
            localStorage.setItem('demographicsTracking', JSON.stringify(demographicsTracking));
            localStorage.setItem('questionAnalytics', JSON.stringify(questionAnalytics));
            localStorage.setItem('funnelAnalytics', JSON.stringify(funnelAnalytics));
        }

        function updateIssuesChart(issuesData) {
            const ctx = document.getElementById('issuesChart');

            if (!issuesData || issuesData.length === 0) {
                if (issuesChart) {
                    issuesChart.destroy();
                }
                return;
            }

            const labels = issuesData.map(([issue]) => issue);
            const data = issuesData.map(([, count]) => count);

            if (issuesChart) {
                issuesChart.destroy();
            }

            issuesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Users Affected',
                        data: data,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(234, 179, 8, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(147, 51, 234, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(14, 165, 233, 0.8)',
                            'rgba(20, 184, 166, 0.8)',
                            'rgba(251, 146, 60, 0.8)'
                        ],
                        borderColor: [
                            'rgba(239, 68, 68, 1)',
                            'rgba(249, 115, 22, 1)',
                            'rgba(234, 179, 8, 1)',
                            'rgba(34, 197, 94, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(147, 51, 234, 1)',
                            'rgba(236, 72, 153, 1)',
                            'rgba(14, 165, 233, 1)',
                            'rgba(20, 184, 166, 1)',
                            'rgba(251, 146, 60, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top Health Issues Distribution',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                bottom: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('userAuthenticated');
                localStorage.removeItem('userEmail');
                window.location.href = 'user-login.html';
            }
        }

        async function playAIInsights() {
            const btn = document.getElementById('aiHelperBtn');
            const originalText = btn.innerHTML;

            try {
                btn.innerHTML = 'ü§ñ Loading audio...';
                btn.disabled = true;

                // 1. Gather dashboard data
                const participants = document.getElementById('totalParticipants').textContent;
                const score = document.getElementById('avgHealthScore').textContent;
                let topIssue = "No major issues reported";
                const commonIssues = document.querySelectorAll('.issue-name span:nth-child(2)');
                if (commonIssues && commonIssues.length > 0) {
                    topIssue = commonIssues[0].textContent;
                }

                // 2. Format a summary sentence
                const summaryText = `Hello! Currently there are ${participants} total participants. The average health score is ${score} out of 100. The most common health issue identified is ${topIssue}.`;

                // 3. Call Sarvam Text-to-Speech API
                const response = await fetch("https://api.sarvam.ai/text-to-speech", {
                    method: "POST",
                    headers: {
                        "api-subscription-key": SARVAM_API_KEY,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "inputs": [summaryText],
                        "target_language_code": "en-IN",
                        "speaker": "tanya",
                        "pitch": 0,
                        "pace": 1.05,
                        "loudness": 1.5,
                        "speech_sample_rate": 8000,
                        "enable_preprocessing": true,
                        "model": "bulbul:v3"
                    })
                });

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const data = await response.json();

                // 4. Play the audio that the API returned
                if (data && data.audios && data.audios[0]) {
                    const audioStr = data.audios[0];
                    const audio = new Audio("data:audio/wav;base64," + audioStr);
                    btn.innerHTML = 'üîä Playing...';

                    audio.onended = () => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    };

                    audio.play();
                } else {
                    throw new Error("No audio payload returned");
                }

            } catch (error) {
                console.error("Sarvam TTS Error:", error);
                alert("Could not generate AI audio. Check console for details.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>