<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher Dashboard - Youth Health Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 50%, #dcfce7 100%);
            background-size: 300% 300%;
            animation: gradientFade 15s ease infinite;
            min-height: 100vh;
        }

        @keyframes gradientFade {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.02);
            padding: 20px 0;
            margin-bottom: 24px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 26px;
            font-weight: bold;
            background: linear-gradient(to right, #16a34a, #22c55e);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            font-size: 14px;
            color: #15803d;
            font-weight: 500;
        }

        .logout-button {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .logout-button:hover {
            background: #dc2626;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 8px 32px rgba(22, 163, 74, 0.05);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        select {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            outline: none;
            cursor: pointer;
            min-width: 160px;
        }

        select:focus {
            border-color: #16a34a;
            box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.1);
        }

        .update-btn {
            background: #16a34a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: auto;
        }

        .update-btn:hover {
            background: #15803d;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(22, 163, 74, 0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.3);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.3);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 15px;
            opacity: 0.9;
        }

        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.08);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        .warning-banner {
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .warning-banner svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .export-btn {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: 12px;
        }

        .export-btn:hover {
            background: #0284c7;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            white-space: nowrap;
        }

        .data-table th {
            background: rgba(22, 163, 74, 0.1);
            color: #16a34a;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>

<body>
    <!-- Check authentication -->
    <script>
        if (localStorage.getItem('researcherAuthenticated') !== 'true') {
            window.location.href = 'researcher-login.html';
        }
    </script>

    <div class="header">
        <div class="header-content">
            <div>
                <h1 class="header-title">Researcher Data Portal</h1>
                <div class="header-subtitle">Anonymous Analytical Insights</div>
            </div>
            <button class="logout-button" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="warning-banner">
            <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                    clip-rule="evenodd"></path>
            </svg>
            <strong>Data Privacy Notice:</strong> All data displayed here is aggregated and fully anonymized. No
            personally identifiable information (PII) is included in these exports.
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label" for="ageFilter">Age Group:</label>
                <select id="ageFilter">
                    <option value="all">All Ages</option>
                    <option value="13-17">13-17 years</option>
                    <option value="18-22">18-22 years</option>
                    <option value="23-27">23-27 years</option>
                    <option value="28-32">28-32 years</option>
                    <option value="33+">33+ years</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="genderFilter">Gender Identity:</label>
                <select id="genderFilter">
                    <option value="all">All Genders</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="non-binary">Non-binary</option>
                    <option value="prefer-not-to-say">Unspecified</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="professionFilter">Current Status:</label>
                <select id="professionFilter">
                    <option value="all">All Statuses</option>
                    <option value="student">Student</option>
                    <option value="working">Working Professional</option>
                    <option value="both">Both (Student & Working)</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <button class="update-btn" onclick="updateDashboard()">Apply Filters</button>
            <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
            <button class="export-btn" id="aiSummaryBtn" onclick="generateResearcherAudio()"
                style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"
                    style="display:inline-block; vertical-align:-3px; margin-right:4px;">
                    <path d="M10 2a4 4 0 014 4v2a4 4 0 01-8 0V6a4 4 0 014-4z"></path>
                    <path fill-rule="evenodd"
                        d="M6 8a1 1 0 00-2 0v2a6.002 6.002 0 005 5.917V19h-1a1 1 0 100 2h4a1 1 0 100-2h-1v-3.083A6.002 6.002 0 0016 10V8a1 1 0 10-2 0v2a4 4 0 01-8 0V8z"
                        clip-rule="evenodd"></path>
                </svg>
                AI Summary
            </button>
        </div>

        <div class="grid">
            <div class="stat-card">
                <div class="stat-value" id="totalAssessments">0</div>
                <div class="stat-label">Total Valid Assessments (Filtered)</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-value" id="topIssueLabel">None</div>
                <div class="stat-label">Most Prevalent Issue</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-value" id="avgSleepLabel">--</div>
                <div class="stat-label">Reporting Sleep Deprivation</div>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <div class="card">
                <h2 class="card-title">Prevalence of Health & Wellness Issues</h2>
                <div class="chart-container">
                    <canvas id="issuesChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">Demographics (Filtered Slice)</h2>
                <div class="chart-container">
                    <canvas id="demographicsPieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 24px;">
            <h2 class="card-title">Detailed Responses (Filtered)</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Participant ID</th>
                            <th>Date</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Status</th>
                            <th>Q1 (Energy)</th>
                            <th>Q2 (Sleep)</th>
                            <th>Q3 (Stress)</th>
                            <th>Q4 (Activity)</th>
                            <th>Q5 (Pain)</th>
                            <th>Q6 (Diet)</th>
                            <th>Q7 (Coping)</th>
                            <th>Q8 (Focus)</th>
                            <th>Q9 (Social)</th>
                            <th>Q10 (Impact)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Data rows injected dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SARVAM_API_KEY = "sk_ln1ow9q0_VyTVyU7GDcGnPVczSPWRJ1Yr";
        let charts = {};
        let allUserData = [];
        let trackingData = [];
        let currentFilteredSet = [];

        // Analyzer logic
        function analyzeIssues(answers) {
            const issues = [];
            if (answers[1] === 'low' || answers[1] === 'very_low') issues.push('Low Energy');
            if (answers[2] === '5-6' || answers[2] === 'less_5') issues.push('Sleep Deprivation');
            if (answers[3] === 'often' || answers[3] === 'daily') issues.push('High Stress/Anxiety');
            if (answers[4] === 'moderate' || answers[4] === 'inactive') issues.push('Physical Inactivity');
            if (answers[5] === 'moderate' || answers[5] === 'severe') issues.push('Physical Pain');
            if (answers[6] === 'fair' || answers[6] === 'poor') issues.push('Poor Nutrition');
            if (answers[7] === 'often' || answers[7] === 'sometimes') issues.push('Coping Difficulties');
            if (answers[8] === 'often') issues.push('Concentration Issues');
            if (answers[9] === 'fair' || answers[9] === 'poor') issues.push('Social Isolation');
            return issues;
        }

        function getMergedDemo(email, baseDemo) {
            const base = baseDemo ? { ...baseDemo } : {};
            const tracked = trackingData.find(d => d.email === email);
            if (tracked) {
                if (!base.age && tracked.age) base.age = tracked.age;
                if (!base.gender && tracked.gender) base.gender = tracked.gender;
                if (!base.profession && tracked.profession) base.profession = tracked.profession;
            }
            return base;
        }

        function initData() {
            seedMockData(); // Ensure mock data exists
            const rawUsers = localStorage.getItem('allUsersData');
            const rawTracking = localStorage.getItem('demographicsTracking');
            allUserData = rawUsers ? JSON.parse(rawUsers) : [];
            trackingData = rawTracking ? JSON.parse(rawTracking) : [];

            // Initial render
            updateDashboard();
        }

        function seedMockData() {
            let allUsersData = [];
            let allUserLogins = [];
            let demographicsTracking = [];
            let questionAnalytics = {};
            let funnelAnalytics = { visited: 0, attempted: 0, completed: 0 };

            const existingData = localStorage.getItem('allUsersData');
            if (existingData) {
                allUsersData = JSON.parse(existingData);
                const mockCount = allUsersData.filter(u => u.email && u.email.startsWith('mockuser')).length;
                if (mockCount >= 300) return; // Already fully seeded

                try { allUserLogins = JSON.parse(localStorage.getItem('allUserLogins') || '[]'); } catch (e) { }
                try { demographicsTracking = JSON.parse(localStorage.getItem('demographicsTracking') || '[]'); } catch (e) { }
                try { questionAnalytics = JSON.parse(localStorage.getItem('questionAnalytics') || '{}'); } catch (e) { }
                try { const f = JSON.parse(localStorage.getItem('funnelAnalytics')); if (f) funnelAnalytics = f; } catch (e) { }

                // Clean out old smaller mock batches
                allUsersData = allUsersData.filter(u => !u.email || !u.email.startsWith('mockuser'));
                allUserLogins = allUserLogins.filter(u => !u.email || !u.email.startsWith('mockuser'));
                demographicsTracking = demographicsTracking.filter(u => !u.email || !u.email.startsWith('mockuser'));
            }

            console.log("Seeding scale mock data for analytics...");
            const numberOfUsers = 300;

            const ages = ['13-17', '18-22', '23-27', '28-32', '33+'];
            const genders = ['male', 'female', 'non-binary', 'prefer-not-to-say'];
            const professions = ['student', 'working', 'both', 'other'];
            const answerOptions = {
                1: ['high', 'moderate', 'low', 'very_low'],
                2: ['9+', '7-8', '5-6', 'less_5'],
                3: ['rarely', 'sometimes', 'often', 'daily'],
                4: ['very_active', 'active', 'moderate', 'inactive'],
                5: ['none', 'mild', 'moderate', 'severe'],
                6: ['excellent', 'good', 'fair', 'poor'],
                7: ['never', 'rarely', 'sometimes', 'often'],
                8: ['never', 'rarely', 'sometimes', 'often'],
                9: ['excellent', 'good', 'fair', 'poor'],
                10: ['none', 'minor', 'moderate', 'major']
            };

            funnelAnalytics.visited += numberOfUsers + 120;
            funnelAnalytics.attempted += numberOfUsers + 45;
            funnelAnalytics.completed += numberOfUsers;

            for (let i = 1; i <= numberOfUsers; i++) {
                const email = `mockuser${i}@example.com`;
                const timestamp = Date.now() - Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000);

                const age = ages[Math.floor(Math.random() * ages.length)];
                const gender = genders[Math.floor(Math.random() * genders.length)];
                const profession = professions[Math.floor(Math.random() * professions.length)];

                const answers = {};
                const questionTimes = {};
                for (let q = 1; q <= 10; q++) {
                    const opts = answerOptions[q];
                    let selectedIndex;
                    if (q === 2 || q === 3) {
                        selectedIndex = Math.min(opts.length - 1, Math.floor(Math.random() * 2) + 2);
                    } else {
                        selectedIndex = Math.floor(Math.random() * opts.length);
                    }
                    answers[q] = opts[selectedIndex];

                    const timeSpent = Math.floor(Math.random() * 8000) + 2000;
                    questionTimes[q] = timeSpent;

                    if (!questionAnalytics[q]) questionAnalytics[q] = [];
                    questionAnalytics[q].push(timeSpent);
                }

                allUsersData.push({
                    email: email,
                    timestamp: timestamp,
                    lastUpdated: timestamp,
                    data: {
                        demographics: { age, profession, gender },
                        questionnaire: {
                            demographics: { age, profession, gender },
                            answers: answers,
                            questionTimes: questionTimes,
                            completedAt: timestamp + 60000
                        },
                        completion: { completed: true, timestamp: timestamp + 60000 }
                    }
                });

                allUserLogins.push({
                    email: email,
                    firstLogin: timestamp - 86400000,
                    lastLogin: timestamp,
                    loginCount: Math.floor(Math.random() * 5) + 1
                });

                demographicsTracking.push({
                    email: email,
                    age: age,
                    gender: gender,
                    profession: profession,
                    timestamp: timestamp
                });
            }

            localStorage.setItem('allUsersData', JSON.stringify(allUsersData));
            localStorage.setItem('allUserLogins', JSON.stringify(allUserLogins));
            localStorage.setItem('demographicsTracking', JSON.stringify(demographicsTracking));
            localStorage.setItem('questionAnalytics', JSON.stringify(questionAnalytics));
            localStorage.setItem('funnelAnalytics', JSON.stringify(funnelAnalytics));
        }

        function updateDashboard() {
            const filterAge = document.getElementById('ageFilter').value;
            const filterGen = document.getElementById('genderFilter').value;
            const filterProf = document.getElementById('professionFilter').value;

            // Filter data
            const validAssessments = allUserData.filter(u => u.data && u.data.questionnaire && u.data.questionnaire.answers);

            const filteredSet = validAssessments.filter(u => {
                const qData = u.data.questionnaire;
                const demo = getMergedDemo(u.email, qData.demographics || {});

                const ageMatch = filterAge === 'all' || demo.age === filterAge;
                const genMatch = filterGen === 'all' || demo.gender === filterGen;
                const profMatch = filterProf === 'all' || demo.profession === filterProf;

                return ageMatch && genMatch && profMatch;
            });

            // Aggregate metrics
            let issueCounts = {
                'Low Energy': 0,
                'Sleep Deprivation': 0,
                'High Stress/Anxiety': 0,
                'Physical Inactivity': 0,
                'Physical Pain': 0,
                'Poor Nutrition': 0,
                'Coping Difficulties': 0,
                'Concentration Issues': 0,
                'Social Isolation': 0
            };

            let ageDemo = { '13-17': 0, '18-22': 0, '23-27': 0, '28-32': 0, '33+': 0, 'unknown': 0 };

            filteredSet.forEach(u => {
                const qData = u.data.questionnaire;
                const userIssues = analyzeIssues(qData.answers);
                userIssues.forEach(i => issueCounts[i]++);

                const demo = getMergedDemo(u.email, qData.demographics || {});
                const age = demo.age || 'unknown';
                ageDemo[age] = (ageDemo[age] || 0) + 1;
            });

            // Top Issue Logic
            const sortedIssues = Object.entries(issueCounts).sort((a, b) => b[1] - a[1]);
            const topIssue = sortedIssues.length > 0 && sortedIssues[0][1] > 0 ? sortedIssues[0][0] : 'None';

            const sleepDeprivationCount = issueCounts['Sleep Deprivation'];
            const sleepPercent = filteredSet.length > 0 ? Math.round((sleepDeprivationCount / filteredSet.length) * 100) : 0;

            // Update DOM
            document.getElementById('totalAssessments').textContent = filteredSet.length;
            document.getElementById('topIssueLabel').textContent = topIssue;
            document.getElementById('avgSleepLabel').textContent = `${sleepPercent}% (${sleepDeprivationCount})`;

            // Charts
            renderIssuesChart(sortedIssues.map(i => i[0]), sortedIssues.map(i => i[1]));

            // Format demographics breakdown for pie
            const pieData = Object.entries(ageDemo).filter(d => d[1] > 0);
            renderDemoChart(pieData.map(d => d[0]), pieData.map(d => d[1]));

            // Store current filter array globally and render table
            currentFilteredSet = filteredSet;
            renderDataTable(filteredSet);
        }

        function renderIssuesChart(labels, data) {
            const ctx = document.getElementById('issuesChart');
            if (charts.issues) charts.issues.destroy();

            // If no data, render empty chart
            if (!labels || labels.length === 0) {
                charts.issues = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['No Data'], datasets: [{ label: 'Occurrences', data: [0] }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                return;
            }

            charts.issues = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reported Occurrences',
                        data: data,
                        backgroundColor: 'rgba(22, 163, 74, 0.7)',
                        borderColor: 'rgba(22, 163, 74, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function renderDemoChart(labels, data) {
            const ctx = document.getElementById('demographicsPieChart');
            if (charts.demo) charts.demo.destroy();

            // If no data, render empty placeholder
            if (!labels || labels.length === 0) {
                charts.demo = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['No Data'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { enabled: false } } }
                });
                return;
            }

            const colors = [
                'rgba(59, 130, 246, 0.8)', // blue
                'rgba(16, 185, 129, 0.8)', // emerald
                'rgba(139, 92, 246, 0.8)', // violet
                'rgba(245, 158, 11, 0.8)', // amber
                'rgba(239, 68, 68, 0.8)'   // red
            ];

            charts.demo = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderDataTable(dataset) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            if (dataset.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" style="text-align:center; padding: 20px;">No data found for the current filters.</td></tr>';
                return;
            }

            dataset.forEach((user, index) => {
                const qData = user.data.questionnaire || {};
                const demo = getMergedDemo(user.email, qData.demographics || {});
                const answers = qData.answers || {};

                const dateStr = new Date(user.timestamp).toLocaleDateString();

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>Participant ${index + 1}</td>
                    <td>${dateStr}</td>
                    <td>${demo.age || 'N/A'}</td>
                    <td style="text-transform: capitalize;">${demo.gender || 'N/A'}</td>
                    <td style="text-transform: capitalize;">${demo.profession || 'N/A'}</td>
                    <td style="text-transform: capitalize;">${(answers[1] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[2] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[3] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[4] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[5] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[6] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[7] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[8] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[9] || 'N/A').replace(/_/g, ' ')}</td>
                    <td style="text-transform: capitalize;">${(answers[10] || 'N/A').replace(/_/g, ' ')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportToCSV() {
            if (!currentFilteredSet || currentFilteredSet.length === 0) {
                alert("No data available to export.");
                return;
            }

            const headers = [
                "Participant ID", "Date", "Age", "Gender", "Status",
                "Q1 (Energy)", "Q2 (Sleep)", "Q3 (Stress)", "Q4 (Activity)",
                "Q5 (Pain)", "Q6 (Diet)", "Q7 (Coping)", "Q8 (Focus)", "Q9 (Social)", "Q10 (Impact)"
            ];

            const rows = [headers.map(h => `"${h}"`).join(",")];

            currentFilteredSet.forEach((user, index) => {
                const qData = user.data.questionnaire || {};
                const demo = getMergedDemo(user.email, qData.demographics || {});
                const answers = qData.answers || {};
                const dateStr = new Date(user.timestamp).toLocaleDateString();

                const rowData = [
                    `Participant ${index + 1}`,
                    dateStr,
                    demo.age || 'N/A',
                    demo.gender || 'N/A',
                    demo.profession || 'N/A',
                    (answers[1] || 'N/A').replace(/_/g, ' '),
                    (answers[2] || 'N/A').replace(/_/g, ' '),
                    (answers[3] || 'N/A').replace(/_/g, ' '),
                    (answers[4] || 'N/A').replace(/_/g, ' '),
                    (answers[5] || 'N/A').replace(/_/g, ' '),
                    (answers[6] || 'N/A').replace(/_/g, ' '),
                    (answers[7] || 'N/A').replace(/_/g, ' '),
                    (answers[8] || 'N/A').replace(/_/g, ' '),
                    (answers[9] || 'N/A').replace(/_/g, ' '),
                    (answers[10] || 'N/A').replace(/_/g, ' ')
                ];

                const csvRow = rowData.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",");
                rows.push(csvRow);
            });

            // Handle UTF-8 safely for Excel
            const csvContent = "\\uFEFF" + rows.join("\\n");

            // Create a blob and use URL.createObjectURL to fix special character issues and file downloading
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "researcher_data_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        function handleLogout() {
            localStorage.removeItem('researcherAuthenticated');
            window.location.href = 'researcher-login.html';
        }

        async function generateResearcherAudio() {
            const btn = document.getElementById('aiSummaryBtn');
            const originalText = btn.innerHTML;

            try {
                btn.innerHTML = 'ðŸ¤– Loading audio...';
                btn.disabled = true;

                // 1. Gather dashboard data
                const assessments = document.getElementById('totalAssessments').textContent;
                const topIssue = document.getElementById('topIssueLabel').textContent;
                const sleepDep = document.getElementById('avgSleepLabel').textContent;

                const ageFilter = document.getElementById('ageFilter').options[document.getElementById('ageFilter').selectedIndex].text;

                // 2. Format a summary sentence
                const summaryText = `Analytic report for the ${ageFilter} cohort: There are ${assessments} validity-checked assessments. The most prevalent issue is ${topIssue}. Furthermore, ${sleepDep} of this cohort reported sleep deprivation.`;

                // 3. Call Sarvam Text-to-Speech API
                const response = await fetch("https://api.sarvam.ai/text-to-speech", {
                    method: "POST",
                    headers: {
                        "api-subscription-key": SARVAM_API_KEY,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "inputs": [summaryText],
                        "target_language_code": "en-IN",
                        "speaker": "tanya",
                        "pitch": 0,
                        "pace": 1.05,
                        "loudness": 1.5,
                        "speech_sample_rate": 8000,
                        "enable_preprocessing": true,
                        "model": "bulbul:v3"
                    })
                });

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const data = await response.json();

                // 4. Play the audio that the API returned
                if (data && data.audios && data.audios[0]) {
                    const audioStr = data.audios[0];
                    const audio = new Audio("data:audio/wav;base64," + audioStr);
                    btn.innerHTML = 'ðŸ”Š Playing...';

                    audio.onended = () => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    };

                    audio.play();
                } else {
                    throw new Error("No audio payload returned");
                }

            } catch (error) {
                console.error("Sarvam TTS Error:", error);
                alert("Could not generate AI audio. Check console for details.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Run
        window.addEventListener('load', initData);
    </script>
</body>

</html>